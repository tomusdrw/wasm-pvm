name: Publish to crates.io

on:
  release:
    types: [published]

env:
  CARGO_TERM_COLOR: always

jobs:
  publish:
    name: Publish crates
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install LLVM 18
        run: sudo apt-get update && sudo apt-get install -y llvm-18-dev libpolly-18-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Publish wasm-pvm (lib)
        run: cargo publish -p wasm-pvm
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Publish wasm-pvm-cli (with retry for crates.io propagation)
        run: |
          max_attempts=5
          attempt=0
          delay=30
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt + 1))
            echo "Attempt $attempt of $max_attempts..."
            if cargo publish -p wasm-pvm-cli 2>&1; then
              echo "Published successfully."
              exit 0
            fi
            if [ $attempt -lt $max_attempts ]; then
              echo "Retrying in ${delay}s..."
              sleep $delay
              delay=$((delay * 2))
            fi
          done
          echo "All $max_attempts attempts failed."
          exit 1
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
